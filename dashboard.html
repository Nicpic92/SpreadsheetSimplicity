<script type="module">
    import { getToken, isAuthenticated, logout, getUser, handleSubscription } from './auth.js';

    if (!isAuthenticated()) {
        window.location.href = '/index.html';
    }

    async function loadDashboard() {
        const user = await getUser();
        if (user && user.email) {
             document.getElementById('user-profile').style.display = 'flex';
             document.getElementById('user-email-display').textContent = user.email;
             document.getElementById('logout-button').addEventListener('click', logout);
        }

        const upgradeSection = document.getElementById('upgrade-section');
        if (user && user.subscription_status === 'free' && !(user.roles && user.roles.includes('admin'))) {
            upgradeSection.style.display = 'block';
            handleSubscription();
        }

        const grid = document.getElementById('tools-grid');
        const proToolsList = document.getElementById('pro-tools-list');
        const loadingMessage = document.getElementById('loading-message');

        try {
            const response = await fetch('/.netlify/functions/get-my-tools', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            if (!response.ok) throw new Error('Could not fetch your tools.');
            
            const data = await response.json();
            const accessibleTools = data.accessibleTools;
            const upsellTools = data.upsellTools;

            loadingMessage.style.display = 'none';
            grid.innerHTML = '';

            if (accessibleTools.length === 0) {
                grid.innerHTML = '<p class="text-gray-600 col-span-full">You currently do not have access to any tools.</p>';
            } else {
                accessibleTools.forEach(tool => {
                    let badge = '';
                    if (tool.access_level === 'pro') badge = '<span class="inline-block bg-indigo-100 text-indigo-800 text-sm font-semibold mt-2 px-3 py-1 rounded-full">Pro Tool</span>';
                    else if (tool.access_level === 'custom') badge = '<span class="inline-block bg-teal-100 text-teal-800 text-sm font-semibold mt-2 px-3 py-1 rounded-full">Custom Tool</span>';
                    
                    // --- THE FIX IS HERE ---
                    // Changed href from "/${tool.filename}" to "./${tool.filename}"
                    // A relative link is often more reliable.
                    const card = `
                        <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col">
                            <div class="flex-shrink-0">${tool.icon_svg || ''}<h4 class="text-2xl font-bold mt-4">${tool.display_name}</h4>${badge}</div>
                            <p class="mt-4 text-gray-600 flex-grow">${tool.description}</p>
                            <a href="./${tool.filename}" class="mt-6 inline-block bg-indigo-600 text-white font-semibold rounded-lg py-3 px-6 text-center hover:bg-indigo-700">Launch Tool</a>
                        </div>
                    `;
                    grid.innerHTML += card;
                });
            }
            
            proToolsList.innerHTML = '';
            if (upsellTools.length > 0) {
                 upsellTools.forEach(tool => {
                    const toolItem = `<div class="flex items-center p-2 bg-gray-50 rounded-md">
                                        <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                        <span class="ml-2 font-medium">${tool.display_name}</span>
                                      </div>`;
                    proToolsList.innerHTML += toolItem;
                });
            }

        } catch (error) {
            loadingMessage.textContent = 'Error loading your dashboard. Please try refreshing the page.';
            console.error(error);
        }
    }

    loadDashboard();
</script>
