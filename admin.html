<script type="module">
    import { getToken, getUser } from './auth.js';

    // This is the single entry point for the page logic
    async function initializeAdminPage() {
        const adminDashboard = document.getElementById('admin-dashboard');
        const accessDenied = document.getElementById('access-denied');
        const userTableBody = document.querySelector('#users-table tbody');

        try {
            // STEP 1: Get the current user's profile. This also validates the token.
            const user = await getUser();

            // STEP 2: Check for admin role.
            const isAdmin = user && user.roles && user.roles.includes('admin');

            if (!isAdmin) {
                // If not an admin, show access denied and stop.
                adminDashboard.style.display = 'none';
                accessDenied.style.display = 'block';
                console.log('Access Denied: User is not an admin.');
                return; 
            }

            // --- If we get here, the user is a verified admin ---
            
            // STEP 3: Show the dashboard and fetch the admin data.
            accessDenied.style.display = 'none';
            adminDashboard.style.display = 'block';
            
            const token = getToken();
            const response = await fetch('/.netlify/functions/get-admin-data', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                // This will catch the 401 if it still happens for some reason
                throw new Error(`Failed to fetch admin data. Server responded with ${response.status}`);
            }

            const allUsers = await response.json();

            // STEP 4: Populate the table with the data.
            userTableBody.innerHTML = ''; // Clear existing rows
            allUsers.forEach(u => {
                const row = `
                    <tr>
                        <td>${u.email}</td>
                        <td>${u.company_name || 'N/A'}</td>
                        <td>${u.subscription_status}</td>
                        <td>${(u.permitted_tools && u.permitted_tools.length) ? u.permitted_tools.join(', ') : 'None'}</td>
                    </tr>
                `;
                userTableBody.innerHTML += row;
            });

        } catch (error) {
            console.error('Error on admin page:', error);
            // General failure, likely due to logged out state or network error.
            adminDashboard.style.display = 'none';
            accessDenied.style.display = 'block';
        }
    }

    // Run the initialization function
    initializeAdminPage();
</script>
