<script type="module">
    import { getToken, getUser } from './auth.js';

    // Get references to DOM elements just once
    const adminDashboard = document.getElementById('admin-dashboard');
    const accessDenied = document.getElementById('access-denied');
    const userTableBody = document.querySelector('#users-table tbody');
    const permissionsModal = document.getElementById('permissions-modal');
    const modalUserEmail = document.getElementById('modal-user-email');
    const toolCheckboxes = document.getElementById('tool-checkboxes');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    // Define global state variables
    let allUsersData = [];
    let availableToolsData = [];

    function openPermissionsModal(userId) {
        // ... (This function remains unchanged)
    }

    async function savePermissions() {
        // ... (This function remains unchanged)
    }

    async function initializeAdminPage() {
        try {
            const user = await getUser();
            const isAdmin = user && JSON.stringify(user.roles).includes('admin');

            if (!isAdmin) {
                adminDashboard.style.display = 'none';
                accessDenied.style.display = 'flex';
                return; 
            }

            // --- THE FIX: SET UP EVENT LISTENERS *AFTER* VERIFYING ADMIN ACCESS ---
            userTableBody.addEventListener('click', (event) => {
                if (event.target.classList.contains('manage-btn')) {
                    openPermissionsModal(event.target.dataset.userId);
                }
            });
            modalCancelBtn.addEventListener('click', () => { permissionsModal.style.display = 'none'; });
            modalSaveBtn.addEventListener('click', savePermissions);
            // --- END OF FIX ---


            adminDashboard.style.display = 'block';
            accessDenied.style.display = 'none';
            
            const response = await fetch('/.netlify/functions/get-admin-data', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            if (!response.ok) throw new Error(`Server responded with ${response.status}`);

            const data = await response.json();
            allUsersData = data.users;
            availableToolsData = data.availableTools;

            userTableBody.innerHTML = '';
            if (allUsersData.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8">No users found.</td></tr>';
            } else {
                allUsersData.forEach(u => {
                    const permittedToolsText = (u.permitted_tools && u.permitted_tools.length > 0)
                        ? u.permitted_tools.join(', ')
                        : 'None';
                    
                    const isAdminBadge = JSON.stringify(u.roles).includes('admin') ? '<span class="ml-2 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Admin</span>' : '';

                    const row = `
                        <tr>
                            <td class="font-medium text-gray-800">${u.email} ${isAdminBadge}</td>
                            <td>${u.company_name || 'N/A'}</td>
                            <td>${u.subscription_status}</td>
                            <td class="text-gray-600">${permittedToolsText}</td>
                            <td>
                                <button class="manage-btn text-indigo-600 hover:text-indigo-900 font-medium" data-user-id="${u.id}">Manage</button>
                            </td>
                        </tr>
                    `;
                    userTableBody.innerHTML += row;
                });
            }
        } catch (error) => {
            console.error('An error occurred on the admin page:', error);
            adminDashboard.style.display = 'none';
            accessDenied.style.display = 'flex';
        }
    }
    
    // Initial load
    initializeAdminPage();
</script>
