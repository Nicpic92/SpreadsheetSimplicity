<script type="module">
    import { getToken, getUser } from './auth.js';

    // Global variables for this page's state
    let allUsersData = [];
    let availableToolsData = [];

    // Get references to DOM elements
    const adminDashboard = document.getElementById('admin-dashboard');
    const accessDenied = document.getElementById('access-denied');
    const userTableBody = document.querySelector('#users-table tbody');
    const permissionsModal = document.getElementById('permissions-modal');
    const modalUserEmail = document.getElementById('modal-user-email');
    const toolCheckboxes = document.getElementById('tool-checkboxes');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    function openPermissionsModal(userId) {
        const user = allUsersData.find(u => u.id === userId);
        if (!user) return;

        modalUserEmail.textContent = user.email;
        toolCheckboxes.innerHTML = ''; // Clear old checkboxes

        availableToolsData.forEach(tool => {
            const isChecked = user.permitted_tools && user.permitted_tools.includes(tool);
            const checkboxHtml = `
                <label class="flex items-center">
                    <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" value="${tool}" ${isChecked ? 'checked' : ''}>
                    <span class="ml-3 text-gray-700">${tool}</span>
                </label>
            `;
            toolCheckboxes.innerHTML += checkboxHtml;
        });
        
        modalSaveBtn.dataset.userId = userId;
        permissionsModal.style.display = 'flex';
    }

    async function savePermissions() {
        const userIdToUpdate = modalSaveBtn.dataset.userId;
        const selectedTools = Array.from(toolCheckboxes.querySelectorAll('input:checked')).map(input => input.value);

        modalSaveBtn.disabled = true;
        modalSaveBtn.textContent = 'Saving...';

        try {
            const response = await fetch('/.netlify/functions/update-user-permissions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getToken()}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userIdToUpdate, tools: selectedTools })
            });

            if (!response.ok) {
                throw new Error('Failed to save permissions.');
            }

            permissionsModal.style.display = 'none';
            // THE FIX: Simply re-run the main initialization function.
            // This will re-fetch all data and redraw the table with the updated permissions.
            await initializeAdminPage(); 
            
        } catch (error) {
            console.error('Save Permissions Error:', error);
            alert('Could not save permissions. Please check the console.');
        } finally {
            modalSaveBtn.disabled = false;
            modalSaveBtn.textContent = 'Save Changes';
        }
    }

    async function initializeAdminPage() {
        try {
            const user = await getUser();
            const isAdmin = user && JSON.stringify(user.roles).includes('admin');

            if (!isAdmin) {
                adminDashboard.style.display = 'none';
                accessDenied.style.display = 'flex';
                return; 
            }

            adminDashboard.style.display = 'block';
            accessDenied.style.display = 'none';
            
            const response = await fetch('/.netlify/functions/get-admin-data', {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            if (!response.ok) throw new Error(`Server responded with ${response.status}`);

            const data = await response.json();
            allUsersData = data.users;
            availableToolsData = data.availableTools;

            userTableBody.innerHTML = '';
            if (allUsersData.length === 0) {
                userTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8">No users found.</td></tr>';
            } else {
                allUsersData.forEach(u => {
                    const permittedToolsText = (u.permitted_tools && u.permitted_tools.length > 0)
                        ? u.permitted_tools.join(', ')
                        : 'None';
                    
                    const isAdminBadge = JSON.stringify(u.roles).includes('admin') ? '<span class="ml-2 text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Admin</span>' : '';

                    const row = `
                        <tr>
                            <td class="font-medium text-gray-800">${u.email} ${isAdminBadge}</td>
                            <td>${u.company_name || 'N/A'}</td>
                            <td>${u.subscription_status}</td>
                            <td class="text-gray-600">${permittedToolsText}</td>
                            <td>
                                <button class="manage-btn text-indigo-600 hover:text-indigo-900 font-medium" data-user-id="${u.id}">Manage</button>
                            </td>
                        </tr>
                    `;
                    userTableBody.innerHTML += row;
                });
            }
        } catch (error) {
            console.error('An error occurred on the admin page:', error);
            adminDashboard.style.display = 'none';
            accessDenied.style.display = 'flex';
        }
    }
    
    // Event listeners
    userTableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('manage-btn')) {
            openPermissionsModal(event.target.dataset.userId);
        }
    });

    modalCancelBtn.addEventListener('click', () => { permissionsModal.style.display = 'none'; });
    modalSaveBtn.addEventListener('click', savePermissions);

    // Initial load
    initializeAdminPage();
</script>
