<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Report Analyzer - Pro Tool</title>
    
    <link href="/output.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style> 
        body { font-family: 'Inter', sans-serif; } 
    </style>
</head>
<body class="text-gray-800 bg-gray-50">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-gray-900">Spreadsheet Simplicity</a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600 font-medium">Tools</a>
                <a href="about.html" class="text-gray-600 hover:text-indigo-600 font-medium">Our Security Promise</a>
                <div class="pl-4">
                    <button id="login-button" class="bg-indigo-600 text-white font-semibold rounded-lg py-2 px-4 hover:bg-indigo-700" style="display:none;">Log In</button>
                    <div id="user-profile" class="items-center space-x-4" style="display:none;">
                        <span class="font-medium text-gray-700">Pro Member</span>
                        <button id="logout-button" class="text-gray-600 hover:text-indigo-600 font-medium">Log Out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <div id="access-denied" class="container mx-auto text-center py-20" style="display:none;">
        <div class="bg-white p-12 rounded-lg shadow-lg max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-red-600">Access Denied</h2>
            <p class="mt-4 text-lg text-gray-700">This is a Pro Tool. Please log in to access this feature.</p>
            <button id="access-login-button" class="mt-8 bg-indigo-600 text-white font-bold text-lg rounded-full py-4 px-10 hover:bg-indigo-700">Log In</button>
        </div>
    </div>

    <main class="container mx-auto my-12 px-6">
        <div class="max-w-4xl mx-auto bg-white p-8 md:p-10 rounded-xl shadow-lg">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold text-gray-900">Automated Report Builder</h1>
                <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">
                    Upload the three source XLSX files. This tool will generate and download a single, fully-formatted Excel report that perfectly replicates your manual process and desired sheet order.
                </p>
            </div>
            
            <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 p-8 bg-gray-50 rounded-lg">
                <div class="border-2 border-dashed border-gray-300 p-6 rounded-lg text-center bg-white flex flex-col justify-center items-center">
                    <label for="mrw9File" class="font-bold text-gray-700 block mb-3 text-lg">1. MRW9 File</label>
                    <input type="file" id="mrw9File" accept=".xlsx" onchange="updateFileName('mrw9File', 'mrw9FileName')" class="hidden">
                    <label for="mrw9File" class="cursor-pointer bg-indigo-100 text-indigo-800 py-2 px-5 rounded-full font-semibold hover:bg-indigo-200 transition-colors">Choose File</label>
                    <span id="mrw9FileName" class="block text-sm text-gray-500 mt-3 truncate w-full px-2">No file selected</span>
                </div>
                <div class="border-2 border-dashed border-gray-300 p-6 rounded-lg text-center bg-white flex flex-col justify-center items-center">
                    <label for="w9DenialsFile" class="font-bold text-gray-700 block mb-3 text-lg">2. W9 Denials File</label>
                    <input type="file" id="w9DenialsFile" accept=".xlsx" onchange="updateFileName('w9DenialsFile', 'w9DenialsFileName')" class="hidden">
                    <label for="w9DenialsFile" class="cursor-pointer bg-indigo-100 text-indigo-800 py-2 px-5 rounded-full font-semibold hover:bg-indigo-200 transition-colors">Choose File</label>
                    <span id="w9DenialsFileName" class="block text-sm text-gray-500 mt-3 truncate w-full px-2">No file selected</span>
                </div>
                <div class="border-2 border-dashed border-gray-300 p-6 rounded-lg text-center bg-white flex flex-col justify-center items-center">
                    <label for="vendorMissingFile" class="font-bold text-gray-700 block mb-3 text-lg">3. Vendor Missing W9 File</label>
                    <input type="file" id="vendorMissingFile" accept=".xlsx" onchange="updateFileName('vendorMissingFile', 'vendorMissingFileName')" class="hidden">
                    <label for="vendorMissingFile" class="cursor-pointer bg-indigo-100 text-indigo-800 py-2 px-5 rounded-full font-semibold hover:bg-indigo-200 transition-colors">Choose File</label>
                    <span id="vendorMissingFileName" class="block text-sm text-gray-500 mt-3 truncate w-full px-2">No file selected</span>
                </div>
            </div>

            <button id="downloadBtn" class="w-full py-4 px-6 text-xl font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-transform transform hover:scale-105" onclick="processAndDownload()">Generate and Download Report</button>
            <div id="loader" class="text-center font-semibold text-indigo-700 p-4" style="display: none;">Processing... Please wait.</div>
            <div id="status" class="text-center mt-4 font-semibold text-lg h-8"></div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto text-center px-6">
            <div class="flex justify-center space-x-6 mb-4"><a href="index.html" class="text-gray-400 hover:text-white">Tools</a><a href="about.html" class="text-gray-400 hover:text-white">Our Security Promise</a></div>
            <p>&copy; 2025 Spreadsheet Simplicity. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- YOUR ORIGINAL UNCHANGED TOOL JAVASCRIPT ---
        function updateFileName(inputId, spanId) {
            const file = document.getElementById(inputId).files[0];
            document.getElementById(spanId).textContent = file ? file.name : 'No file selected';
        }

        const readExcelFile = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error("File not found."));
                const reader = new FileReader();
                reader.onload = (event) => {
                    const data = event.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
                    resolve(jsonData);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsBinaryString(file);
            });
        };

        const filterFooterRows = (data) => {
            if (!data || data.length === 0) return [];
            const footerText = "No filters applied";
            return data.filter(row => {
                const firstColumnKey = Object.keys(row)[0];
                if (!firstColumnKey) return false;
                const firstColumnValue = row[firstColumnKey];
                return typeof firstColumnValue !== 'string' || !firstColumnValue.includes(footerText);
            });
        };

        const createPivot = (data, rowField, valueField, type = 'count') => {
            if (!data || data.length === 0) return [];
            
            const pivotData = data.reduce((acc, row) => {
                const rowValue = String(row[rowField] || 'BLANK').toUpperCase();
                if (!acc[rowValue]) {
                    acc[rowValue] = (type === 'distinctCount') ? new Set() : 0;
                }
                if (type === 'count') {
                    acc[rowValue]++;
                } else if (type === 'distinctCount' && row[valueField]) {
                    acc[rowValue].add(row[valueField]);
                }
                return acc;
            }, {});

            const valueHeader = type === 'distinctCount' ? `Distinct Count of ${valueField}` : `Count of ${valueField}`;
            const result = Object.keys(pivotData).sort().map(key => ({
                [rowField]: key,
                [valueHeader]: (type === 'distinctCount') ? pivotData[key].size : pivotData[key],
            }));
            
            const total = result.reduce((sum, row) => sum + row[valueHeader], 0);
            result.push({ [rowField]: 'Grand Total', [valueHeader]: total });
            return result;
        };

        async function processAndDownload() {
            const btn = document.getElementById('downloadBtn');
            const loader = document.getElementById('loader');
            const status = document.getElementById('status');

            btn.disabled = true;
            loader.style.display = 'block';
            status.textContent = '';
            status.classList.remove('text-red-600', 'text-green-600');

            try {
                const mrw9File = document.getElementById('mrw9File').files[0];
                const w9DenialsFile = document.getElementById('w9DenialsFile').files[0];
                const vendorMissingFile = document.getElementById('vendorMissingFile').files[0];

                if (!mrw9File || !w9DenialsFile || !vendorMissingFile) {
                    throw new Error("Please upload all three required files.");
                }

                status.textContent = 'Reading and cleaning files...';
                let [mrw9Data, w9DenialsData, vendorMissingData] = await Promise.all([
                    readExcelFile(mrw9File),
                    readExcelFile(w9DenialsFile),
                    readExcelFile(vendorMissingFile)
                ]);

                mrw9Data = filterFooterRows(mrw9Data);
                w9DenialsData = filterFooterRows(w9DenialsData);
                vendorMissingData = filterFooterRows(vendorMissingData);

                const workbook = XLSX.utils.book_new();

                status.textContent = 'Analyzing and preparing data...';

                const p1 = createPivot(mrw9Data, 'MRW9 in PV', 'Claim ID');
                const nonValidatedClaims = mrw9Data.filter(row => String(row['VENDOR NOT VALIDATED IN CLAIM']).toUpperCase() === 'YES');
                const p2 = createPivot(nonValidatedClaims, 'MRW9 in PV', 'Claim ID');
                const p3 = createPivot(mrw9Data, 'MRW9 in PV', 'Billing TAX ID', 'distinctCount');
                const p4 = createPivot(vendorMissingData, 'IsW9GenerationLetterRequested', 'VendorLegalName');
                const p5 = createPivot(w9DenialsData, 'W9 Attached in PV (YES/NO)', 'Patient Ctrl No');
                const p6 = createPivot(w9DenialsData, 'W9 Attached in PV (YES/NO)', 'Billing Provider Tax ID', 'distinctCount');
                
                const denialsWithW9 = w9DenialsData.filter(row => String(row['W9 Attached in PV (YES/NO)']).toUpperCase() === 'YES');
                const notValidatedWithW9 = mrw9Data.filter(row => String(row['VENDOR NOT VALIDATED IN CLAIM']).toUpperCase() === 'YES' && String(row['MRW9 in PV']).toUpperCase() === 'YES');
                
                status.textContent = 'Building Pivots sheet...';
                const pivotsSheet = XLSX.utils.aoa_to_sheet([[]]);
                const merges = [];
                
                let leftCurrentRow = 1;
                const addLeftPivot = (title, data) => {
                    XLSX.utils.sheet_add_aoa(pivotsSheet, [[title]], { origin: `A${leftCurrentRow}` });
                    if (data.length > 0) merges.push({ s: { r: leftCurrentRow - 1, c: 0 }, e: { r: leftCurrentRow - 1, c: 1 } });
                    leftCurrentRow++;
                    XLSX.utils.sheet_add_json(pivotsSheet, data, { origin: `A${leftCurrentRow}`, skipHeader: false });
                    leftCurrentRow += data.length + 2;
                };

                let rightCurrentRow = 1;
                const addRightPivot = (title, data) => {
                    XLSX.utils.sheet_add_aoa(pivotsSheet, [[title]], { origin: `E${rightCurrentRow}` });
                    if (data.length > 0) merges.push({ s: { r: rightCurrentRow - 1, c: 4 }, e: { r: rightCurrentRow - 1, c: 5 } });
                    rightCurrentRow++;
                    XLSX.utils.sheet_add_json(pivotsSheet, data, { origin: `E${rightCurrentRow}`, skipHeader: false });
                    rightCurrentRow += data.length + 2;
                };

                addLeftPivot("MRW9's in PV", p1);
                addLeftPivot("MRW9's Vendor Not Validated with W9", p2);
                addLeftPivot("MRW9's in PV by TIN", p3);
                
                addRightPivot("Missing W9's - Requested", p4);
                addRightPivot("W9 Denials - With W9's Attached in PV", p5);
                addRightPivot("W9 Denials - With W9's Attached by TIN", p6);

                pivotsSheet['!merges'] = merges;
                
                status.textContent = 'Assembling final workbook...';
                const greenTab = { rgb: "C6EFCE" };
                const yellowTab = { rgb: "FFFF00" };

                XLSX.utils.book_append_sheet(workbook, pivotsSheet, 'Pivots');
                
                const denialsWithW9Sheet = XLSX.utils.json_to_sheet(denialsWithW9);
                denialsWithW9Sheet['!props'] = { tabColor: greenTab };
                XLSX.utils.book_append_sheet(workbook, denialsWithW9Sheet, 'Denials with W9');
                
                const notValidatedWithW9Sheet = XLSX.utils.json_to_sheet(notValidatedWithW9);
                notValidatedWithW9Sheet['!props'] = { tabColor: greenTab };
                XLSX.utils.book_append_sheet(workbook, notValidatedWithW9Sheet, 'MRW9 Not Validated w W9');

                const mrw9SourceSheet = XLSX.utils.json_to_sheet(mrw9Data);
                mrw9SourceSheet['!props'] = { tabColor: yellowTab };
                XLSX.utils.book_append_sheet(workbook, mrw9SourceSheet, 'Source_MRW9');

                const denialsSourceSheet = XLSX.utils.json_to_sheet(w9DenialsData);
                denialsSourceSheet['!props'] = { tabColor: yellowTab };
                XLSX.utils.book_append_sheet(workbook, denialsSourceSheet, 'Source_W9_Denials');

                const missingSourceSheet = XLSX.utils.json_to_sheet(vendorMissingData);
                missingSourceSheet['!props'] = { tabColor: yellowTab };
                XLSX.utils.book_append_sheet(workbook, missingSourceSheet, 'Source_Vendor_Missing_W9');
                
                status.textContent = 'Finalizing file...';
                XLSX.writeFile(workbook, "Automated_W9_Analysis_Report.xlsx");
                status.textContent = 'Download complete!';
                status.classList.add('text-green-600');

            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-600');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
    
    <script type="module">
        import { initializeAuth0, updateAuthUI, protectPage } from './auth.js';
        (async () => {
            await initializeAuth0();
            await updateAuthUI();
            await protectPage();
        })();
    </script>
</body>
</html>
