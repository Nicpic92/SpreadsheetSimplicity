<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLSX Validator - Pro Tool</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .issue-ignored { text-decoration: line-through; color: #9ca3af; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 25px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link.active { background-color: #4f46e5; color: white; }
        .full-screen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; padding: 1rem; }
        .modal-content-area { background-color: #ffffff; padding: 1.5rem 2rem; border-radius: 0.75rem; width: 95%; max-width: 1800px; display: flex; flex-direction: column; max-height: 95vh; }
        #rulesTableContainer, #ruleCategoryEditorContainer { flex-grow: 1; overflow: auto; border: 1px solid #e2e8f0; border-radius: 0.5rem; }
        #rulesTable th { background-color: #f8fafc; font-weight: 600; position: sticky; top: 0; z-index: 5; }
        #rulesTable th, #rulesTable td, .duplicate-glimpse-table th, .duplicate-glimpse-table td { padding: 8px 12px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: top; }
        .delete-btn { background-color: #ef4444; color: white; border: none; padding: 2px 6px; font-size: 0.75em; border-radius: 4px; cursor: pointer; }
        .rule-pill { display: inline-flex; align-items: center; background-color: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 9999px; font-size: 0.8em; margin: 2px; }
        .category-list-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #e2e8f0; }
        .category-list-item:hover { background-color: #f1f5f9; }
        .category-list-item.selected { background-color: #4f46e5; color: white; font-weight: 600; }
        .error-details { max-height: 400px; overflow-y: auto; background-color: #f8fafc; border: 1px solid #e2e8f0; margin-top: 4px; padding: 8px; border-radius: 4px; }
        textarea.description-input { resize: vertical; min-height: 38px; overflow-y: hidden; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-gray-900">Spreadsheet Simplicity</a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600 font-medium">Tools</a>
                <a href="about.html" class="text-gray-600 hover:text-indigo-600 font-medium">Our Security Promise</a>
                <div class="pl-4">
                    <button id="login-button" class="bg-indigo-600 text-white font-semibold rounded-lg py-2 px-4 hover:bg-indigo-700">Log In</button>
                    <div id="user-profile" class="items-center space-x-4" style="display:none;">
                        <span class="font-medium text-gray-700">Pro Member</span>
                        <button id="logout-button" class="text-gray-600 hover:text-indigo-600 font-medium">Log Out</button>
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <div id="access-denied" class="container mx-auto text-center py-20" style="display:none;">
        <div class="bg-white p-12 rounded-lg shadow-lg max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-red-600">Access Denied</h2>
            <p class="mt-4 text-lg text-gray-700">This tool requires a Pro subscription. Please log in or upgrade to access this feature.</p>
            <button id="access-login-button" class="mt-8 bg-indigo-600 text-white font-bold text-lg rounded-full py-4 px-10 hover:bg-indigo-700">Log In</button>
        </div>
    </div>

    <main>
        <div class="bg-gray-700 text-white">
            <div class="container mx-auto px-6 py-3 flex flex-col md:flex-row justify-between items-center">
                 <h1 class="text-2xl font-bold">XLSX Validator</h1>
                 <nav class="bg-gray-800 p-1 rounded-lg mt-2 md:mt-0">
                    <a href="#" class="nav-link px-4 py-2 rounded-md font-semibold" data-view="validation-hub-view">Validation Hub</a>
                    <a href="#" class="nav-link px-4 py-2 rounded-md font-semibold" data-view="backup-view">Backup & Restore</a>
                </nav>
            </div>
        </div>
        <div class="flex-grow container mx-auto p-6 md:p-8">
            <div id="validation-hub-view">
                <section class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Start a New Validation</h2>
                    <p id="dictionaryStatus" class="text-center text-sm text-gray-500 mb-6"></p>
                    <div class="border-t pt-6 space-y-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-700">1. Upload Data File</h3>
                            <p class="text-sm text-gray-600 mb-3">Select the Excel or CSV file to validate. It will be processed locally in your browser.</p>
                            <input type="file" id="workflow_excelFile" accept=".xlsx, .xls, .csv" class="w-full text-sm text-gray-500 border rounded-lg cursor-pointer bg-gray-50 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:bg-gray-200 hover:file:bg-gray-300">
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-700">2. Select Duplicate Detection Method</h3>
                            <p class="text-sm text-gray-600 mb-3">Choose how to check for duplicate rows. "Thorough" is more powerful but slower on very large files.</p>
                            <select id="duplicate_method" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="thorough">Thorough (>50% Similarity)</option>
                                <option value="fast">Fast (Exact Match Only)</option>
                                <option value="none">None (Fastest)</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <button id="workflow_analyzeBtn" class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Analyze File</button>
                        <div class="loader mt-4 hidden" id="workflow_loader"></div>
                    </div>
                </section>
                <section id="schema-results-view" class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-4xl mx-auto mt-8 hidden"></section>
                <section id="validation-results-view" class="max-w-6xl mx-auto mt-8 hidden"></section>
            </div>
            <div id="backup-view" class="hidden">
                 <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Manage Dictionary</h2>
                    <div class="space-y-6">
                        <div><h3 class="text-lg font-bold text-gray-700">Edit Stored Dictionary</h3><p class="text-sm text-gray-600 mb-3">Modify the rules for individual columns.</p><button id="backup_editBtn" class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md">Open Dictionary Editor</button></div>
                        <div class="border-t pt-6"><h3 class="text-lg font-bold text-gray-700">Manage Rule Categories</h3><p class="text-sm text-gray-600 mb-3">Create and edit reusable rule templates.</p><button id="backup_manageCategoriesBtn" class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md">Open Rule Category Editor</button></div>
                        <div class="border-t pt-6"><h3 class="text-lg font-bold text-gray-700">Download Full Dictionary PDF</h3><p class="text-sm text-gray-600 mb-3">Save a structured PDF of the entire dictionary.</p><button id="backup_downloadPdfBtn" class="w-full py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-md">Download Dictionary.pdf</button></div>
                        <div class="border-t pt-6"><h3 class="text-lg font-bold text-gray-700">Download Backup (JSON)</h3><p class="text-sm text-gray-600 mb-3">Save the dictionary and rule categories to a `.json` file.</p><button id="backup_downloadBtn" class="w-full py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md">Download Backup.json</button></div>
                        <div class="border-t pt-6"><h3 class="text-lg font-bold text-gray-700">Restore from Backup</h3><p class="text-sm text-gray-600 mb-3">Upload a `.json` backup file. This will **overwrite** all stored data.</p><input type="file" id="backup_uploadFile" accept=".json" class="w-full text-sm text-gray-500 border rounded-lg cursor-pointer bg-gray-50 file:mr-4 file:py-2 file:px-4 file:rounded-l-lg file:border-0 file:bg-gray-200 hover:file:bg-gray-300"></div>
                        <div class="border-t pt-6"><h3 class="text-lg font-bold text-red-700">Clear Stored Dictionary</h3><p class="text-sm text-gray-600 mb-3">Permanently delete all data from your browser.</p><button id="backup_wipeBtn" class="w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md">Wipe Data</button></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="bg-gray-800 text-white py-8 mt-auto">
        <div class="container mx-auto text-center px-6">
            <div class="flex justify-center space-x-6 mb-4"><a href="index.html" class="text-gray-400 hover:text-white">Tools</a><a href="about.html" class="text-gray-400 hover:text-white">Our Security Promise</a></div>
            <p>&copy; 2025 Spreadsheet Simplicity. All rights reserved.</p>
        </div>
    </footer>
    <!-- MODALS -->
    <div id="dictionaryModal" class="full-screen-overlay hidden">
        <div class="modal-content-area">
            <div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold text-gray-800">Define Data Dictionary Rules</h3><button onclick="closeModal('dictionaryModal')" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">×</button></div>
            <div class="mb-4"><label for="builder_dictionaryName" class="block text-sm font-medium">Data Dictionary Name</label><input type="text" id="builder_dictionaryName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
            <div id="rulesTableContainer"><table id="rulesTable" class="w-full text-sm"><thead><tr><th>Column</th><th>Rule Category</th><th>Description</th><th>Defined Rules</th><th>Add New Rule</th></tr></thead><tbody></tbody></table></div>
            <div class="text-right mt-6"><button id="builder_saveAndCloseBtn" class="py-3 px-6 rounded-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700">Save and Close</button></div>
        </div>
    </div>
    <div id="ruleCategoryModal" class="full-screen-overlay hidden">
        <div class="modal-content-area">
            <div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold text-gray-800">Manage Rule Categories</h3><button id="categoryEditorCloseBtn" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">×</button></div>
            <div class="flex gap-6 flex-grow min-h-0">
                <div class="w-1/3 flex flex-col border rounded-lg"><div class="p-2 border-b"><button class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-md" onclick="addNewRuleCategory()">+ Add New Category</button></div><div id="ruleCategoryList" class="flex-grow overflow-y-auto"></div></div>
                <div id="ruleCategoryEditorContainer" class="w-2/3 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="text-xl font-bold mb-4" id="categoryEditorTitle"></h4>
                    <div class="mb-4"><h5 class="font-semibold mb-2">Defined Rules</h5><div id="categoryRulesDisplay" class="flex flex-wrap gap-2 p-2 min-h-[40px] border rounded-md bg-white"></div></div>
                    <div><h5 class="font-semibold mb-2">Add New Rule</h5><div class="flex gap-2 items-center"><select id="categoryRuleType" class="p-1 border rounded-md bg-white w-1/3"><option value="REQUIRED">REQUIRED</option> <option value="NOT REQUIRED">NOT REQUIRED</option> <option value="ALLOWED_VALUES">ALLOWED_VALUES</option> <option value="REGEX">REGEX</option> <option value="VALID_DATE">VALID_DATE</option> <option value="NO_FUTURE_DATE">NO_FUTURE_DATE</option></select><input id="categoryRuleValue" type="text" placeholder="Value (if needed)..." class="p-1 border rounded-md w-1/3"><button class="py-1 px-3 bg-indigo-500 text-white rounded-md text-sm" onclick="addRuleToCategory()">+</button></div></div>
                    <div class="mt-auto pt-4 text-right"><button class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md mr-2" onclick="deleteRuleCategory()">Delete Category</button></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- YOUR ORIGINAL UNCHANGED VALIDATOR JAVASCRIPT ---
        const DICTIONARY_STORAGE_KEY = 'rcmDataHub_dictionary';
        const RULE_CATEGORY_STORAGE_KEY = 'rcmDataHub_ruleCategories';
        const ROW_LIMIT = 50000;
        let appState = {
            currentFile: null, currentFileHeaders: [], dictionary: getStoredDictionary(), ruleCategories: getStoredRuleCategories(),
            lastValidationResult: null, ignoredErrors: new Set(), currentEditingCategory: null, pendingAssignments: []
        };
        function getStoredDictionary() { try { return JSON.parse(localStorage.getItem(DICTIONARY_STORAGE_KEY)) || { dictionaryName: 'New Dictionary', sheetsData: {} }; } catch (e) { return { dictionaryName: 'New Dictionary', sheetsData: {} }; } }
        function getStoredRuleCategories() {
            let defaultCategories = {
                "Date (Any, Valid Format)": { "rules": [{ "type": "VALID_DATE", "value": "", "message": "Value must be a valid date." }] },
                "Date (No Future)": { "rules": [{ "type": "NO_FUTURE_DATE", "value": "", "message": "Date cannot be in the future." }] }
            };
            try { const stored = JSON.parse(localStorage.getItem(RULE_CATEGORY_STORAGE_KEY)); return stored ? { ...defaultCategories, ...stored } : defaultCategories; } catch (e) { return defaultCategories; }
        }
        function initializeMaster() {
            updateDictionaryStatus();
            document.getElementById('workflow_excelFile').addEventListener('change', handleFileSelect);
            document.getElementById('workflow_analyzeBtn').addEventListener('click', analyzeFileWorkflow);
            document.getElementById('builder_saveAndCloseBtn').addEventListener('click', saveAndCloseBuilder);
            document.getElementById('backup_editBtn').addEventListener('click', launchEditorForEditing);
            document.getElementById('backup_manageCategoriesBtn').addEventListener('click', () => openRuleCategoryEditor(false));
            document.getElementById('backup_downloadPdfBtn').addEventListener('click', downloadFullPdfDictionary);
            document.getElementById('backup_downloadBtn').addEventListener('click', downloadBackup);
            document.getElementById('backup_uploadFile').addEventListener('change', handleRestoreUpload);
            document.getElementById('backup_wipeBtn').addEventListener('click', wipeStoredDictionary);
            document.getElementById('categoryEditorCloseBtn').addEventListener('click', handleCategoryEditorClose);
            document.querySelectorAll('.nav-link[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(link.dataset.view);
                });
            });
            switchView('validation-hub-view');
        }
        function switchView(viewId) {
            ['validation-hub-view', 'backup-view'].forEach(id => {
                const view = document.getElementById(id);
                if (view) view.classList.add('hidden');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.remove('hidden');
            document.querySelectorAll('.nav-link[data-view]').forEach(link => {
                link.classList.toggle('active', link.dataset.view === viewId);
            });
        }
        function showLoader(loaderId) { document.getElementById(loaderId).classList.remove('hidden'); }
        function hideLoader(loaderId) { document.getElementById(loaderId).classList.add('hidden'); }
        function updateDictionaryStatus() { appState.dictionary = getStoredDictionary(); const statusEl = document.getElementById('dictionaryStatus'); statusEl.textContent = appState.dictionary.dictionaryName ? `Using dictionary: "${appState.dictionary.dictionaryName}"` : 'No dictionary stored. Analyzing a file will help create one.'; statusEl.classList.toggle('text-green-600', !!appState.dictionary.dictionaryName); statusEl.classList.toggle('text-red-500', !appState.dictionary.dictionaryName); }
        async function analyzeFileWorkflow() {
            document.getElementById('schema-results-view').classList.add('hidden'); document.getElementById('validation-results-view').classList.add('hidden');
            appState.lastValidationResult = null; appState.ignoredErrors.clear();
            if (!appState.currentFile) { alert('Please select a file first.'); return; }
            showLoader('workflow_loader');
            const fileHeaders = getAllHeadersFromFile(appState.currentFile); appState.currentFileHeaders = fileHeaders;
            const dictHeaders = getAllHeadersFromDictionary(appState.dictionary);
            const missingHeaders = fileHeaders.filter(header => !dictHeaders.has(header.toUpperCase()));
            if (missingHeaders.length > 0) { displaySchemaMismatchUI(missingHeaders); hideLoader('workflow_loader'); } 
            else { await runDataValidation(appState.currentFile, appState.dictionary); hideLoader('workflow_loader'); }
        }
        function displaySchemaMismatchUI(missingHeaders) {
            const existingColumns = Object.values(appState.dictionary.sheetsData).map(col => col['Column Name']).filter(Boolean).sort((a, b) => a.localeCompare(b));
            const copyOptions = existingColumns.map(name => `<option value="${name}">${name}</option>`).join('');
            let schemaHTML = `<div class="p-4 border-l-4 border-yellow-400 bg-yellow-50 rounded-r-lg"><h3 class="text-lg font-bold text-yellow-800">New Columns Detected</h3><p class="text-sm text-yellow-700 mt-2">New columns were found in your file. To include them in the validation, please define their rules below. You can select a pre-defined category or create a new one. Columns without a description will be excluded from the report.</p></div><div class="mt-4 space-y-4">`;
            const categoryOptions = Object.keys(appState.ruleCategories).sort().map(catName => `<option value="${catName}">${catName}</option>`).join('');
            missingHeaders.forEach((header, index) => {
                schemaHTML += `<div class="p-3 bg-slate-50 rounded-md" data-missing-header="${header}"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-start"><div><label class="block text-sm font-semibold text-slate-800">${header}</label><select class="category-select w-full mt-1 p-2 border rounded-md" onchange="handleCategoryChoice(this, ${index})"><option value="">-- Select a Category --</option><option value="__CREATE_NEW__" class="font-bold text-blue-600">** Create a New Rule Category **</option>${categoryOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">Description</label><textarea oninput="autoAdjustTextarea(this)" class="description-input w-full mt-1 p-2 border rounded-md" placeholder="Enter description..."></textarea><select class="w-full mt-2 p-1.5 border rounded-md bg-gray-50 text-sm" onchange="copySettingsFromExisting(this)"><option value="">-- Or, copy settings from an existing field --</option>${copyOptions}</select></div></div><div id="inline-editor-${index}" class="inline-editor hidden mt-4 p-4 border-t border-slate-200"><div class="mb-2"><label class="block text-sm font-medium text-gray-700">New Category Name:</label><input type="text" class="new-category-name w-full p-2 border rounded-md" placeholder="Enter Unique Category Name..."></div><div class="mb-2"><label class="block text-sm font-medium text-gray-700">Defined Rules:</label><div class="inline-rules-display flex flex-wrap gap-2 p-2 min-h-[40px] border rounded-md bg-white"></div></div><div><label class="block text-sm font-medium text-gray-700">Add New Rule:</label><div class="flex gap-2 items-center"><select class="inline-rule-type p-1 border rounded-md bg-white flex-1"><option value="REQUIRED">REQUIRED</option><option value="NOT REQUIRED">NOT REQUIRED</option><option value="ALLOWED_VALUES">ALLOWED_VALUES</option><option value="REGEX">REGEX</option><option value="VALID_DATE">VALID_DATE</option><option value="NO_FUTURE_DATE">NO_FUTURE_DATE</option></select><input type="text" placeholder="Value..." class="inline-rule-value p-1 border rounded-md flex-1"><button type="button" class="py-1 px-3 bg-blue-500 text-white rounded-md text-sm" onclick="addRuleToInlineCategory(this)">+</button></div></div></div></div>`;
            });
            schemaHTML += `</div><div class="text-center mt-6"><button id="workflow_proceedBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-md">Apply & Continue</button></div>`;
            document.getElementById('schema-results-view').innerHTML = schemaHTML; document.getElementById('schema-results-view').classList.remove('hidden');
            document.getElementById('workflow_proceedBtn').addEventListener('click', handleMappingProceed);
        }
        function copySettingsFromExisting(selectElement) { const selectedColumnName = selectElement.value; if (!selectedColumnName) return; const columnData = Object.values(appState.dictionary.sheetsData).find(col => col['Column Name'] === selectedColumnName); if (columnData) { const container = selectElement.closest('[data-missing-header]'); const descriptionInput = container.querySelector('.description-input'); const categorySelect = container.querySelector('.category-select'); descriptionInput.value = columnData.description || ''; autoAdjustTextarea(descriptionInput); if (columnData.category && categorySelect.querySelector(`option[value="${columnData.category}"]`)) { categorySelect.value = columnData.category; const inlineEditor = container.querySelector('.inline-editor'); if (inlineEditor) { inlineEditor.classList.add('hidden'); } } } selectElement.value = ''; }
        function handleCategoryChoice(selectElement, index) { document.getElementById(`inline-editor-${index}`).classList.toggle('hidden', selectElement.value !== '__CREATE_NEW__'); }
        function addRuleToInlineCategory(button) { const editor = button.closest('.inline-editor'); const type = editor.querySelector('.inline-rule-type').value; const valueInput = editor.querySelector('.inline-rule-value'); const value = valueInput.value.trim(); if (['ALLOWED_VALUES', 'REGEX'].includes(type) && !value) { alert("Value is required for this rule type."); return; } const display = editor.querySelector('.inline-rules-display'); const pill = document.createElement('span'); pill.className = 'rule-pill'; pill.dataset.type = type; pill.dataset.value = value; pill.innerHTML = `${type}: ${value || 'N/A'} <button type="button" class="delete-btn ml-2" onclick="this.parentElement.remove()">x</button>`; display.appendChild(pill); valueInput.value = ''; }
        function handleMappingProceed() {
            const assignments = []; const newCategories = {}; const allCategoryNames = new Set(Object.keys(appState.ruleCategories)); let hasError = false;
            const skippedColumns = [];
            document.querySelectorAll('[data-missing-header]').forEach(div => {
                const header = div.dataset.missingHeader; const categorySelect = div.querySelector('.category-select'); const descriptionInput = div.querySelector('.description-input');
                if (categorySelect.value) {
                    const description = descriptionInput.value.trim();
                    if (!description) { skippedColumns.push(header); return; }
                    const assignment = { header, description };
                    if (categorySelect.value === '__CREATE_NEW__') {
                        const editor = div.querySelector('.inline-editor'); const newCatName = editor.querySelector('.new-category-name').value.trim();
                        if (!newCatName) { alert(`Please enter a name for the new category for column "${header}".`); hasError = true; return; }
                        if (allCategoryNames.has(newCatName)) { alert(`The category name "${newCatName}" already exists or has been used. Please choose a unique name.`); hasError = true; return; }
                        assignment.category = newCatName; const rules = [];
                        editor.querySelectorAll('.inline-rules-display .rule-pill').forEach(pill => { rules.push({ type: pill.dataset.type, value: pill.dataset.value, message: `Validation failed for rule ${pill.dataset.type}` }); });
                        newCategories[newCatName] = { rules }; allCategoryNames.add(newCatName);
                    } else { assignment.category = categorySelect.value; }
                    assignments.push(assignment);
                } else { skippedColumns.push(header); }
            });
            if (hasError) return;
            const continueProcessing = () => { if (Object.keys(newCategories).length > 0) { appState.ruleCategories = { ...appState.ruleCategories, ...newCategories }; saveRuleCategoriesToStorage(); } appState.pendingAssignments = assignments; appState.lastValidationResult = { skippedColumns: skippedColumns }; applyPendingAssignments(); saveDictionaryToStorage(appState.dictionary); commitMappingsAndValidate(); };
            if (skippedColumns.length > 0) { if (confirm(`You have not provided details for some columns. These columns will be excluded from the validation. Do you still want to run the report with the remaining fields?`)) { continueProcessing(); } } 
            else { continueProcessing(); }
        }
        function applyPendingAssignments() { appState.pendingAssignments.forEach(assignment => { const { header, category, description } = assignment; const rules = appState.ruleCategories[category]?.rules || []; const headerKey = header.toUpperCase(); if (!appState.dictionary.sheetsData[headerKey]) { appState.dictionary.sheetsData[headerKey] = { "Column Name": header, validation_rules: JSON.parse(JSON.stringify(rules)), category: category, description: description }; } }); appState.pendingAssignments = []; }
        async function commitMappingsAndValidate() { document.getElementById('schema-results-view').classList.add('hidden'); showLoader('workflow_loader'); await runDataValidation(appState.currentFile, appState.dictionary); hideLoader('workflow_loader'); }
        function launchEditorForEditing() { const headers = Object.values(appState.dictionary.sheetsData).map(rule => rule["Column Name"]).filter(Boolean); openBuilderModal(headers); }
        function openBuilderModal(headers) { document.getElementById('builder_dictionaryName').value = appState.dictionary.dictionaryName; renderBuilderTable(headers); document.getElementById('dictionaryModal').classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function renderBuilderTable(headers) {
            const tbody = document.querySelector('#rulesTable tbody'); tbody.innerHTML = ''; const dictData = appState.dictionary.sheetsData; const categoryOptions = Object.keys(appState.ruleCategories).sort().map(catName => `<option value="${catName}">${catName}</option>`).join('');
            headers.sort((a,b) => a.localeCompare(b)).forEach(header => {
                const headerKey = header.toUpperCase(); const columnData = dictData[headerKey]; const row = tbody.insertRow();
                let rulesToDisplay = [];
                if (columnData.category && appState.ruleCategories[columnData.category]) { rulesToDisplay = appState.ruleCategories[columnData.category].rules; } 
                else { rulesToDisplay = columnData.validation_rules; }
                let rulesHTML = '<div class="flex flex-wrap gap-1">';
                rulesToDisplay.forEach((rule, index) => { const deleteAction = columnData.category ? '' : `<button class="delete-btn ml-2" onclick="deleteRule('${headerKey}', ${index})">x</button>`; rulesHTML += `<span class="rule-pill">${rule.type}: ${rule.value || 'N/A'} ${deleteAction}</span>`; });
                rulesHTML += '</div>';
                const addRuleHTML = `<div class="flex gap-2 items-center"><select class="p-1 border rounded-md bg-white w-1/3"><option value="REQUIRED">REQUIRED</option><option value="NOT REQUIRED">NOT REQUIRED</option><option value="ALLOWED_VALUES">ALLOWED_VALUES</option><option value="REGEX">REGEX</option><option value="VALID_DATE">VALID_DATE</option><option value="NO_FUTURE_DATE">NO_FUTURE_DATE</option></select><input type="text" placeholder="Value..." class="p-1 border rounded-md w-1/3"><button class="py-1 px-3 bg-blue-500 text-white rounded-md text-sm" onclick="addRule(this, '${headerKey}')">+</button></div>`;
                const categoryHTML = `<td><select onchange="applyRuleCategory('${headerKey}', this.value)" class="p-1 border rounded-md w-full"><option value="">-- None --</option>${categoryOptions}</select></td>`;
                const descriptionHTML = `<td><textarea oninput="autoAdjustTextarea(this)" onchange="updateDescription('${headerKey}', this.value)" class="description-input p-1 border rounded-md w-full">${columnData.description || ''}</textarea></td>`;
                row.innerHTML = `<td class="font-semibold align-middle">${header}<button class="delete-btn ml-4" onclick="deleteColumn('${headerKey}')">Delete</button></td>${categoryHTML}${descriptionHTML}<td>${rulesHTML}</td><td>${addRuleHTML}</td>`;
                row.querySelector('select').value = columnData.category || '';
                autoAdjustTextarea(row.querySelector('textarea'));
            });
        }
        function applyRuleCategory(headerKey, categoryName) { const columnData = appState.dictionary.sheetsData[headerKey]; if (!columnData) return; if (categoryName === "") { columnData.validation_rules = []; columnData.category = ""; } else { const categoryTemplate = appState.ruleCategories[categoryName]; if (categoryTemplate && confirm(`This will replace all existing rules for "${columnData['Column Name']}" with the rules from the "${categoryName}" category. Are you sure?`)) { columnData.validation_rules = JSON.parse(JSON.stringify(categoryTemplate.rules)); columnData.category = categoryName; } } renderBuilderTable(Object.values(appState.dictionary.sheetsData).map(r => r["Column Name"])); }
        function updateDescription(headerKey, newDescription) { if (appState.dictionary.sheetsData[headerKey]) appState.dictionary.sheetsData[headerKey].description = newDescription; }
        function addRule(buttonElement, headerKey) { const addRuleContainer = buttonElement.closest('div'); const select = addRuleContainer.querySelector('select'); const input = addRuleContainer.querySelector('input[type="text"]'); const ruleType = select.value, ruleValue = input.value.trim(); if (['ALLOWED_VALUES', 'REGEX'].includes(ruleType) && !ruleValue) { alert('Rule Value is required.'); return; } appState.dictionary.sheetsData[headerKey].validation_rules.push({ type: ruleType, value: ruleValue, message: `Validation failed for rule ${ruleType}` }); appState.dictionary.sheetsData[headerKey].category = ''; renderBuilderTable(Object.values(appState.dictionary.sheetsData).map(r => r["Column Name"])); }
        function deleteRule(headerKey, ruleIndex) { appState.dictionary.sheetsData[headerKey].validation_rules.splice(ruleIndex, 1); appState.dictionary.sheetsData[headerKey].category = ''; renderBuilderTable(Object.values(appState.dictionary.sheetsData).map(r => r["Column Name"])); }
        function deleteColumn(headerKey) { if(appState.dictionary.sheetsData[headerKey] && confirm(`Are you sure you want to delete the column "${appState.dictionary.sheetsData[headerKey]["Column Name"]}"?`)){ delete appState.dictionary.sheetsData[headerKey]; renderBuilderTable(Object.values(appState.dictionary.sheetsData).map(r => r["Column Name"])); } }
        function saveAndCloseBuilder() { appState.dictionary.dictionaryName = document.getElementById('builder_dictionaryName').value; saveDictionaryToStorage(appState.dictionary); closeModal('dictionaryModal'); }
        function openRuleCategoryEditor(isWorkflowStep = false) { appState.currentEditingCategory = null; const closeBtn = document.getElementById('categoryEditorCloseBtn'); if (isWorkflowStep) { closeBtn.textContent = 'Save & Continue →'; closeBtn.onclick = handleCategoryEditorClose; } else { closeBtn.textContent = '×'; closeBtn.onclick = () => closeModal('ruleCategoryModal'); } document.getElementById('ruleCategoryEditorContainer').classList.add('hidden'); renderRuleCategoryList(); document.getElementById('ruleCategoryModal').classList.remove('hidden'); }
        function handleCategoryEditorClose() { closeModal('ruleCategoryModal'); if (appState.pendingAssignments.length > 0) { applyPendingAssignments(); saveDictionaryToStorage(appState.dictionary); commitMappingsAndValidate(); } }
        function renderRuleCategoryList() { const listEl = document.getElementById('ruleCategoryList'); listEl.innerHTML = ''; const sortedCategories = Object.keys(appState.ruleCategories).sort(); sortedCategories.forEach(catName => { const item = document.createElement('div'); item.className = 'category-list-item'; item.textContent = catName; if (catName === appState.currentEditingCategory) item.classList.add('selected'); item.onclick = () => selectRuleCategoryToEdit(catName); listEl.appendChild(item); }); }
        function selectRuleCategoryToEdit(categoryName) { if(appState.currentEditingCategory) saveRuleCategoriesToStorage(); appState.currentEditingCategory = categoryName; renderRuleCategoryList(); const editorEl = document.getElementById('ruleCategoryEditorContainer'); editorEl.classList.remove('hidden'); document.getElementById('categoryEditorTitle').textContent = `Editing: ${categoryName}`; renderCategoryRulesDisplay(); }
        function renderCategoryRulesDisplay() { const displayEl = document.getElementById('categoryRulesDisplay'); displayEl.innerHTML = ''; const category = appState.ruleCategories[appState.currentEditingCategory]; if (!category || !category.rules) return; category.rules.forEach((rule, index) => { const pill = document.createElement('span'); pill.className = 'rule-pill'; pill.innerHTML = `${rule.type}: ${rule.value || 'N/A'} <button class="delete-btn ml-2" onclick="deleteRuleFromCategory(${index})">x</button>`; displayEl.appendChild(pill); }); }
        function addNewRuleCategory() { const name = prompt("Enter a name for the new rule category:"); if (name && !appState.ruleCategories[name]) { appState.ruleCategories[name] = { rules: [] }; selectRuleCategoryToEdit(name); } else if (name) { alert("A category with this name already exists."); } }
        function deleteRuleCategory() { const catName = appState.currentEditingCategory; if (catName && confirm(`Are you sure you want to permanently delete the "${catName}" category?`)) { delete appState.ruleCategories[catName]; appState.currentEditingCategory = null; saveRuleCategoriesToStorage(); document.getElementById('ruleCategoryEditorContainer').classList.add('hidden'); renderRuleCategoryList(); } }
        function addRuleToCategory() { const catName = appState.currentEditingCategory; if (!catName) return; const type = document.getElementById('categoryRuleType').value; const valueInput = document.getElementById('categoryRuleValue'); const value = valueInput.value.trim(); if (['ALLOWED_VALUES', 'REGEX'].includes(type) && !value) { alert("Value is required for this rule type."); return; } appState.ruleCategories[catName].rules.push({ type, value, message: `Validation failed for rule ${type}` }); valueInput.value = ''; renderCategoryRulesDisplay(); saveRuleCategoriesToStorage(); }
        function deleteRuleFromCategory(index) { const catName = appState.currentEditingCategory; if (catName) { appState.ruleCategories[catName].rules.splice(index, 1); renderCategoryRulesDisplay(); saveRuleCategoriesToStorage(); } }
        function saveRuleCategoriesToStorage() { try { localStorage.setItem(RULE_CATEGORY_STORAGE_KEY, JSON.stringify(appState.ruleCategories)); } catch (e) { alert("Could not save rule categories."); } }
        function parseDate(value) { if (value === null || value === undefined || String(value).trim() === '') return null; if (typeof value === 'number' && value > 1 && value <= 2958465) { return new Date((value - 25569) * 86400 * 1000); } const date = new Date(String(value)); return isNaN(date.getTime()) ? null : date; }
        async function runDataValidation(file, dictionary) {
            const analysisResults = {}, overallStats = { customIssueCount: 0, duplicateRowCount: 0, totalProcessedCells: 0, totalProcessedRows: 0, totalOriginalRows: 0 };
            const duplicateMethod = document.getElementById('duplicate_method').value;
            for (const sheetName of file.SheetNames) {
                const worksheet = file.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null, raw: true });
                if (jsonData.length < 2) continue;
                const sheetHeader = jsonData[0].map(h => String(h || '').trim()); let sheetDataRows = jsonData.slice(1);
                overallStats.totalOriginalRows += sheetDataRows.length; if (sheetDataRows.length > ROW_LIMIT) { sheetDataRows = sheetDataRows.slice(0, ROW_LIMIT); }
                const currentSheetIssues = { customValidation: {}, duplicateRows: [], sheetHeaders: sheetHeader };
                if (duplicateMethod !== 'none') {
                    const seenAsDuplicate = new Set();
                    for (let i = 0; i < sheetDataRows.length; i++) {
                        if (seenAsDuplicate.has(i)) continue;
                        for (let j = i + 1; j < sheetDataRows.length; j++) {
                            if (seenAsDuplicate.has(j)) continue;
                            const rowA = sheetDataRows[i], rowB = sheetDataRows[j];
                            if (duplicateMethod === 'fast') { if (rowA.join('~!~') === rowB.join('~!~')) { currentSheetIssues.duplicateRows.push({ rowNumber1: i + 2, rowData1: rowA, rowNumber2: j + 2, rowData2: rowB, matchPercentage: 100 }); seenAsDuplicate.add(j); } } 
                            else { let matchingCells = 0; for (let k = 0; k < rowA.length; k++) { if (String(rowA[k] || '').trim() === String(rowB[k] || '').trim()) { matchingCells++; } } const matchPercentage = (matchingCells / rowA.length) * 100; if (matchPercentage > 50) { currentSheetIssues.duplicateRows.push({ rowNumber1: i + 2, rowData1: rowA, rowNumber2: j + 2, rowData2: rowB, matchPercentage: matchPercentage.toFixed(0) }); seenAsDuplicate.add(j); } }
                        }
                    }
                    overallStats.duplicateRowCount += currentSheetIssues.duplicateRows.length;
                }
                sheetHeader.forEach((header, colIndex) => {
                    const headerKey = header.toUpperCase(); let ruleset = dictionary.sheetsData[headerKey]; if (!ruleset) return;
                    let finalRules = [];
                    if (ruleset.category && appState.ruleCategories[ruleset.category]) { finalRules = appState.ruleCategories[ruleset.category].rules; } 
                    else { finalRules = ruleset.validation_rules; }
                    if (!finalRules || finalRules.length === 0) return;
                    currentSheetIssues.customValidation[header] = []; const otherRules = finalRules.filter(r => r.type !== 'ALLOWED_VALUES'); const allowedValuesRules = finalRules.filter(r => r.type === 'ALLOWED_VALUES');
                    if (allowedValuesRules.length > 0) { const combined = new Set(allowedValuesRules.flatMap(r => String(r.value).split(',')).map(v => v.trim().toLowerCase())); otherRules.push({ type: 'ALLOWED_VALUES_COMBINED', value: combined, message: `Value not in allowed list for ${header}` }); }
                    otherRules.forEach(rule => {
                        sheetDataRows.forEach((row, rowIndex) => {
                            overallStats.totalProcessedCells++; const cellValue = row[colIndex], isCellEmpty = (cellValue === undefined || cellValue === null || String(cellValue).trim() === '');
                            if (rule.type === 'NOT REQUIRED' || (rule.type !== 'REQUIRED' && rule.type !== 'NO_FUTURE_DATE' && rule.type !== 'VALID_DATE' && isCellEmpty)) return;
                            let isValid = true;
                            switch (rule.type) {
                                case 'REQUIRED': isValid = !isCellEmpty; break;
                                case 'ALLOWED_VALUES_COMBINED': isValid = isCellEmpty || rule.value.has(String(cellValue).trim().toLowerCase()); break;
                                case 'REGEX': isValid = isCellEmpty || new RegExp(rule.value, 'i').test(String(cellValue)); break;
                                case 'VALID_DATE': if (isCellEmpty) { isValid = true; break; } isValid = parseDate(cellValue) !== null; if(!isValid) rule.message = "Value is not a recognizable date."; break;
                                case 'NO_FUTURE_DATE': if (isCellEmpty) { isValid = true; break; } const parsedDate = parseDate(cellValue); if (!parsedDate) { isValid = false; rule.message = "Value is not a recognizable date."; } else { const today = new Date(); today.setHours(23, 59, 59, 999); if (parsedDate > today) { isValid = false; rule.message = `Date ${parsedDate.toLocaleDateString()} is in the future.`; } else { isValid = true; } } break;
                            }
                            if (!isValid) { currentSheetIssues.customValidation[header].push({ row: rowIndex + 2, value: cellValue, type: rule.type.replace('_COMBINED', ''), message: rule.message }); }
                        });
                    });
                    overallStats.customIssueCount += currentSheetIssues.customValidation[header].length;
                });
                analysisResults[sheetName] = currentSheetIssues;
            }
            appState.lastValidationResult = { ...appState.lastValidationResult, fileName: file.name, results: analysisResults, stats: overallStats, headers: getAllHeadersFromFile(file) };
            displayValidationReport();
        }
        function displayValidationReport() {
            const { fileName, results, stats } = appState.lastValidationResult;
            const view = document.getElementById('validation-results-view'); view.classList.remove('hidden');
            let html = `<div class="bg-white p-6 md:p-8 rounded-xl shadow-lg"><h2 class="text-2xl font-bold text-slate-700 mb-4">Data Validation Report</h2>`;
            if (stats.totalOriginalRows > ROW_LIMIT) { html += `<div class="p-4 mb-4 border-l-4 border-blue-400 bg-blue-50 rounded-r-lg"><h3 class="text-sm font-bold text-blue-800">Note: This file contains more than ${ROW_LIMIT.toLocaleString()} rows. To ensure performance, the validation score and error report are based on an analysis of the first ${ROW_LIMIT.toLocaleString()} rows.</h3></div>`; }
            html += `<p class="text-sm text-gray-500 mb-4">File: ${fileName}</p><div id="report-summary" class="bg-slate-50 p-4 rounded-lg mb-6"></div>`;
            for(const sheetName in results) {
                html += `<div class="mb-6"><h3 class="text-xl font-bold text-slate-700 mb-3 border-b pb-2">Sheet: ${sheetName}</h3><ul class="space-y-2 text-sm">`;
                const issues = results[sheetName]; let hasIssues = false;
                if (issues.duplicateRows.length > 0) {
                    hasIssues = true; const issueKey = `dupe_${sheetName}`; let glimpseHTML = '<div class="space-y-4">';
                    const sheetHeaders = issues.sheetHeaders || [];
                    issues.duplicateRows.slice(0, 20).forEach(d => {
                        glimpseHTML += `<div class="p-2 border rounded-md bg-white"><p class="font-semibold text-sm">Row ${d.rowNumber1} is ${d.matchPercentage}% similar to Row ${d.rowNumber2}</p><table class="w-full text-xs mt-2 duplicate-glimpse-table"><thead><tr><th class="w-1/3">Header</th><th class="w-1/3">Row ${d.rowNumber1} Data</th><th class="w-1/3">Row ${d.rowNumber2} Data</th></tr></thead><tbody>`;
                        for(let i=0; i < Math.max(d.rowData1.length, d.rowData2.length); i++) { const headerName = sheetHeaders[i] || `(Column ${i+1})`; const val1 = d.rowData1[i] !== null && d.rowData1[i] !== undefined ? String(d.rowData1[i]) : ''; const val2 = d.rowData2[i] !== null && d.rowData2[i] !== undefined ? String(d.rowData2[i]) : ''; const highlight = val1.trim() !== val2.trim() ? 'bg-yellow-100' : ''; glimpseHTML += `<tr class="${highlight}"><td class="font-semibold text-gray-600">${headerName}</td><td>${val1}</td><td>${val2}</td></tr>`; }
                        glimpseHTML += `</tbody></table></div>`;
                    });
                    glimpseHTML += '</div>';
                    html += `<li><div class="flex items-center"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" onchange="toggleIgnore('${issueKey}')" class="form-checkbox h-4 w-4 mr-2"><strong>Similar Rows Found:</strong> ${issues.duplicateRows.length} pairs.</label><button class="ml-2 text-blue-500 text-xs" onclick="toggleErrorDetails(this)">(show)</button></div><div class="error-details hidden">${glimpseHTML}</div></li>`;
                }
                for (const col in issues.customValidation) {
                    if (issues.customValidation[col].length > 0) { hasIssues = true; const issueKey = `val_${sheetName}_${col}`; const colI = issues.customValidation[col]; html += `<li><div class="flex items-center"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" onchange="toggleIgnore('${issueKey}')" class="form-checkbox h-4 w-4 mr-2"><strong>Column "${col}":</strong> ${colI.length} issues.</label><button class="ml-2 text-blue-500 text-xs" onclick="toggleErrorDetails(this)">(show)</button></div><div class="error-details hidden"><ul class="list-disc list-inside">${colI.slice(0, 50).map(i => `<li>Row ${i.row}: Failed '${i.type}' (Value: "${i.value}"). Message: ${i.message}</li>`).join('')}</ul></div></li>`; }
                }
                if (!hasIssues) html += `<li class="text-green-700 font-semibold">No issues found in this sheet.</li>`;
                html += `</ul></div>`;
            }
            html += `<div class="flex flex-col md:flex-row gap-4 mt-6 border-t pt-6"><button id="downloadReportBtn" class="flex-1 py-3 px-4 rounded-lg text-lg font-medium text-white bg-green-600 hover:bg-green-700">Download Scored Report</button><button onclick="downloadSubsetDictionary()" class="flex-1 py-3 px-4 rounded-lg text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700">Download Subset Dictionary</button><button onclick="downloadSubsetPdf()" class="flex-1 py-3 px-4 rounded-lg text-lg font-medium text-white bg-gray-600 hover:bg-gray-700">Download Subset PDF</button></div></div>`;
            view.innerHTML = html; document.getElementById('downloadReportBtn').addEventListener('click', downloadScoredReport); recalculateScores();
        }
        function saveDictionaryToStorage(dictObject) { try { dictObject.lastModified = new Date().toISOString(); localStorage.setItem(DICTIONARY_STORAGE_KEY, JSON.stringify(dictObject)); updateDictionaryStatus(); } catch (e) { alert("Could not save dictionary."); } }
        function wipeStoredDictionary() { if (confirm("Are you sure? This will delete the dictionary AND all rule categories.")) { localStorage.removeItem(DICTIONARY_STORAGE_KEY); localStorage.removeItem(RULE_CATEGORY_STORAGE_KEY); appState.dictionary = getStoredDictionary(); appState.ruleCategories = getStoredRuleCategories(); alert("Stored data cleared."); updateDictionaryStatus(); } }
        function downloadBackup() { const backupData = { dictionary: getStoredDictionary(), ruleCategories: getStoredRuleCategories() }; if (!backupData.dictionary) { alert("Nothing to download."); return; } const blob = new Blob([JSON.stringify(backupData, null, 2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${(backupData.dictionary.dictionaryName||'dictionary').replace(/[^a-z0-9]/gi,'_')}_backup.json`; a.click(); URL.revokeObjectURL(a.href); }
        function handleRestoreUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { try { const backupData = JSON.parse(e.target.result); const loadedDict = backupData.dictionary; const loadedCategories = backupData.ruleCategories || {}; if (!loadedDict || !loadedDict.dictionaryName || !loadedDict.sheetsData) throw new Error("Backup file is missing a valid dictionary."); if (confirm(`This will overwrite your dictionary with "${loadedDict.dictionaryName}" and restore all rule categories. Are you sure?`)) { saveDictionaryToStorage(loadedDict); appState.ruleCategories = loadedCategories; saveRuleCategoriesToStorage(); alert("Restored successfully."); event.target.value = ''; } } catch(err) { alert(`Error restoring file: ${err.message}`); } }; reader.readAsText(file); }
        function autoAdjustTextarea(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; }
        function getAllHeadersFromFile(workbook) { const h=new Set(); workbook.SheetNames.forEach(s=>{const j=XLSX.utils.sheet_to_json(workbook.Sheets[s],{header:1,defval:null}); if(j.length>0)j[0].forEach(e=>{if(e)h.add(String(e).trim())})}); return Array.from(h); }
        function getAllHeadersFromDictionary(dictionary) { return dictionary && dictionary.sheetsData ? new Set(Object.keys(dictionary.sheetsData).map(k=>k.toUpperCase())) : new Set(); }
        function handleFileSelect(event){const file=event.target.files[0],analyzeBtn=document.getElementById('workflow_analyzeBtn');if(!file){appState.currentFile=null;analyzeBtn.disabled=true;return}const reader=new FileReader();reader.onload=e=>{try{appState.currentFile={...XLSX.read(new Uint8Array(e.target.result),{type:'array'}),name:file.name};analyzeBtn.disabled=false}catch(error){alert("Could not read file.");appState.currentFile=null;analyzeBtn.disabled=true}};reader.readAsArrayBuffer(file)}
        function toggleErrorDetails(button){const d=button.parentElement.nextElementSibling;const i=d.classList.contains('hidden');d.classList.toggle('hidden',!i);button.textContent=i?'(hide)':'(show)'}
        function toggleIgnore(key){if(appState.ignoredErrors.has(key)){appState.ignoredErrors.delete(key)}else{appState.ignoredErrors.add(key)}document.querySelector(`input[onchange="toggleIgnore('${key}')"]`).closest('li').classList.toggle('issue-ignored',appState.ignoredErrors.has(key));recalculateScores()}
        function recalculateScores(){const{results,stats}=appState.lastValidationResult;let ignoredCustomCount=0,ignoredDupeCount=0;appState.ignoredErrors.forEach(key=>{if(key.startsWith('dupe_'))ignoredDupeCount+=results[key.substring(5)].duplicateRows.length;else if(key.startsWith('val_')){const parts=key.split('_');ignoredCustomCount+=results[parts[1]].customValidation[parts.slice(2).join('_')].length}});const effectiveCustomCount=stats.customIssueCount-ignoredCustomCount;const effectiveDupeCount=stats.duplicateRowCount-ignoredDupeCount;const totalErrors=effectiveCustomCount+effectiveDupeCount;const totalChecks=stats.totalProcessedCells+stats.totalProcessedRows;const cleanRate=totalChecks>0?Math.max(0,((totalChecks-totalErrors)/totalChecks)*100):100;const passStatus=cleanRate>=95;const statusClass=passStatus?'text-green-600 font-bold':'text-red-600 font-bold';document.getElementById('report-summary').innerHTML=`<p><strong>Overall Status:</strong> <span class="${statusClass}">${passStatus?'Pass':'Fail'}</span> (Clean Rate: ${cleanRate.toFixed(2)}%, Threshold: 95%)</p><p>Showing ${effectiveCustomCount} validation issues and ${effectiveDupeCount} similar row pairs.</p>`}
        function downloadSubsetDictionary(){if(!appState.dictionary||appState.currentFileHeaders.length===0){alert("Analyze a file first.");return}const headersToKeep=new Set(appState.currentFileHeaders.map(h=>h.toUpperCase()));const subsetDict={...appState.dictionary,sheetsData:{}};for(const headerKey in appState.dictionary.sheetsData){if(headersToKeep.has(headerKey.toUpperCase()))subsetDict.sheetsData[headerKey]=appState.dictionary.sheetsData[headerKey]}subsetDict.dictionaryName+=` (Subset for ${appState.currentFile.name})`;const backupData={dictionary:subsetDict,ruleCategories:getStoredRuleCategories()};const blob=new Blob([JSON.stringify(backupData,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Subset_Dictionary.json`;a.click();URL.revokeObjectURL(a.href)}
        function downloadScoredReport() {
            if (!appState.lastValidationResult) { alert("Please run a validation first."); return; }
            const { fileName, results, headers } = appState.lastValidationResult; const newWb = XLSX.utils.book_new();
            const duplicateData = [];
            if (Object.values(results).some(r => r.duplicateRows.length > 0)) {
                duplicateData.push(["Original Sheet", "Row Number", "Match %", "Matched With Row", ...headers]);
                for (const sheetName in results) {
                    if (appState.ignoredErrors.has(`dupe_${sheetName}`)) continue;
                    results[sheetName].duplicateRows.forEach(d => {
                        duplicateData.push([sheetName, d.rowNumber1, `${d.matchPercentage}%`, d.rowNumber2, ...d.rowData1]);
                        duplicateData.push([sheetName, d.rowNumber2, `${d.matchPercentage}%`, d.rowNumber1, ...d.rowData2]);
                    });
                }
                const dupesWs = XLSX.utils.aoa_to_sheet(duplicateData); XLSX.utils.book_append_sheet(newWb, dupesWs, "Duplicate Rows");
            }
            const errorDetailsByRow = {};
            for (const sheetName in results) {
                errorDetailsByRow[sheetName] = {};
                for (const col in results[sheetName].customValidation) {
                    if (appState.ignoredErrors.has(`val_${sheetName}_${col}`)) continue;
                    results[sheetName].customValidation[col].forEach(issue => { const existing = errorDetailsByRow[sheetName][issue.row] || ''; const newError = `Column '${col}': ${issue.message || issue.type}`; errorDetailsByRow[sheetName][issue.row] = existing ? `${existing}; ${newError}` : newError; });
                }
            }
            const errorData = []; let headersAdded = false;
            appState.currentFile.SheetNames.forEach(sheetName => {
                const errorRowNumbers = Object.keys(errorDetailsByRow[sheetName]).map(Number);
                if (errorRowNumbers.length > 0) {
                    const originalData = XLSX.utils.sheet_to_json(appState.currentFile.Sheets[sheetName], { header: 1, raw: true });
                    if (!headersAdded) { errorData.push(["Original Sheet Name", "Error Details", ...headers]); headersAdded = true; }
                    errorRowNumbers.sort((a,b) => a - b).forEach(rowNum => { if(originalData[rowNum - 1]) errorData.push([sheetName, errorDetailsByRow[sheetName][rowNum], ...originalData[rowNum - 1]]); });
                }
            });
            if (errorData.length > 0) { const errorsWs = XLSX.utils.aoa_to_sheet(errorData); XLSX.utils.book_append_sheet(newWb, errorsWs, "Validation Errors"); }
            
            appState.currentFile.SheetNames.forEach(sheetName => {
                const originalSheet = appState.currentFile.Sheets[sheetName];
                const aoa = XLSX.utils.sheet_to_json(originalSheet, { header: 1, raw: true, defval: null });
                if (aoa.length > ROW_LIMIT + 1) { 
                    aoa.splice(ROW_LIMIT + 1); 
                } 
                const limitedWs = XLSX.utils.aoa_to_sheet(aoa); 
                XLSX.utils.book_append_sheet(newWb, limitedWs, sheetName); 
            });

            let ignoredCustomCount=0,ignoredDupeCount=0;appState.ignoredErrors.forEach(key=>{if(key.startsWith('dupe_'))ignoredDupeCount+=results[key.substring(5)].duplicateRows.length;else if(key.startsWith('val_')){const parts=key.split('_');ignoredCustomCount+=results[parts[1]].customValidation[parts.slice(2).join('_')].length}});const effectiveTotalErrors=(appState.lastValidationResult.stats.customIssueCount-ignoredCustomCount)+(appState.lastValidationResult.stats.duplicateRowCount-ignoredDupeCount);const totalChecks=appState.lastValidationResult.stats.totalProcessedCells+appState.lastValidationResult.stats.totalProcessedRows;const cleanRate=totalChecks>0?(((totalChecks-effectiveTotalErrors)/totalChecks)*100):100;
            const summaryData = [ ["Data Validation Summary Report"], [], ["File Name", fileName], ["Dictionary Name", appState.dictionary.dictionaryName], ["Timestamp", new Date().toLocaleString()], [], ["Overall Status", cleanRate >= 95 ? "Pass" : "Fail"], ["Final Clean Rate", `${cleanRate.toFixed(2)}%`], ["Effective Validation Issues", appState.lastValidationResult.stats.customIssueCount - ignoredCustomCount], ["Effective Similar Row Pairs", appState.lastValidationResult.stats.duplicateRowCount - ignoredDupeCount] ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData); XLSX.utils.book_append_sheet(newWb, summaryWs, "Validation Summary");
            const desiredOrder = ["Validation Summary", "Duplicate Rows", "Validation Errors"]; const reorderedSheets = desiredOrder.filter(name => newWb.SheetNames.includes(name)); newWb.SheetNames.forEach(name => { if (!reorderedSheets.includes(name)) reorderedSheets.push(name); }); newWb.SheetNames = reorderedSheets;
            XLSX.writeFile(newWb, `Validated_${fileName}`);
        }
        function downloadSubsetPdf() {
            if (!appState.dictionary || !appState.lastValidationResult) { alert("Analyze a file first."); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
            const { headers: fileHeaders, skippedColumns } = appState.lastValidationResult;
            const headersToKeep = new Set(fileHeaders.map(h => h.toUpperCase())); const tableBody = []; const tableHead = ['Column Name', 'Rule Category', 'Description', 'Defined Rules'];
            
            fileHeaders.forEach(header => {
                const headerKey = header.toUpperCase();
                if (headersToKeep.has(headerKey) && (!skippedColumns || !skippedColumns.includes(header))) {
                    const ruleData = appState.dictionary.sheetsData[headerKey];
                    if (ruleData) {
                        let rulesToDisplay = [];
                        if (ruleData.category && appState.ruleCategories[ruleData.category]) { rulesToDisplay = appState.ruleCategories[ruleData.category].rules; }
                        else { rulesToDisplay = ruleData.validation_rules; }
                        const rulesText = rulesToDisplay.map(r => `${r.type}${r.value ? `: ${r.value}` : ''}`).join('\n');
                        tableBody.push([ ruleData['Column Name'], ruleData.category || 'N/A', ruleData.description || '', rulesText ]);
                    }
                }
            });
            
            doc.setFontSize(18); doc.text("Data Dictionary Subset Report", 14, 22);
            doc.setFontSize(11); doc.text(`Dictionary: ${appState.dictionary.dictionaryName}`, 14, 30); doc.text(`Source File: ${appState.currentFile.name}`, 14, 36);
            doc.autoTable({ startY: 40, head: [tableHead], body: tableBody, theme: 'grid', headStyles: { fillColor: [22, 160, 133] }, styles: { fontSize: 8, cellPadding: 1.5 }, columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 40 }, 2: { cellWidth: 'auto' }, 3: { cellWidth: 65 } } });
            
            if (skippedColumns && skippedColumns.length > 0) {
                doc.addPage();
                doc.setFontSize(18); doc.text("Columns Excluded From Dictionary", 14, 22);
                doc.setFontSize(11); doc.text("The following columns were not saved to the dictionary because no description was provided.", 14, 30);
                const skippedTableBody = skippedColumns.map(col => [col]);
                doc.autoTable({ startY: 40, head: [['Excluded Column Name']], body: skippedTableBody, theme: 'grid' });
            }

            doc.save(`Subset_Dictionary_For_${appState.currentFile.name}.pdf`);
        }
        function downloadFullPdfDictionary() {
            const dictionary = getStoredDictionary();
            if (!dictionary || Object.keys(dictionary.sheetsData).length === 0) { alert("No dictionary stored to download."); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
            const tableBody = []; const tableHead = ['Column Name', 'Rule Category', 'Description', 'Defined Rules'];
            const sortedKeys = Object.keys(dictionary.sheetsData).sort((a,b) => dictionary.sheetsData[a]['Column Name'].localeCompare(dictionary.sheetsData[b]['Column Name']));
            sortedKeys.forEach(headerKey => {
                const ruleData = dictionary.sheetsData[headerKey];
                let rulesToDisplay = [];
                if (ruleData.category && appState.ruleCategories[ruleData.category]) { rulesToDisplay = appState.ruleCategories[ruleData.category].rules; }
                else { rulesToDisplay = ruleData.validation_rules; }
                const rulesText = rulesToDisplay.map(r => `${r.type}${r.value ? `: ${r.value}` : ''}`).join('\n');
                tableBody.push([ ruleData['Column Name'], ruleData.category || 'N/A', ruleData.description || '', rulesText ]);
            });
            doc.setFontSize(18); doc.text("Full Data Dictionary Report", 14, 22);
            doc.setFontSize(11); doc.text(`Dictionary: ${dictionary.dictionaryName}`, 14, 30); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 36);
            doc.autoTable({ startY: 40, head: [tableHead], body: tableBody, theme: 'grid', headStyles: { fillColor: [41, 128, 185] }, styles: { fontSize: 8, cellPadding: 1.5 }, columnStyles: { 0: { cellWidth: 40 }, 1: { cellWidth: 40 }, 2: { cellWidth: 'auto' }, 3: { cellWidth: 65 } } });
            doc.save(`${dictionary.dictionaryName.replace(/[^a-z0-9]/gi,'_')}.pdf`);
        }
        document.addEventListener('DOMContentLoaded', initializeMaster);
    </script>
    
    <!-- START: AUTHENTICATION MODAL -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4" style="display:none;">
      <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="p-8">
          <h3 id="auth-modal-title" class="text-2xl font-bold text-center text-gray-900">Log In</h3>
          <div class="mt-6">
            <div class="space-y-4">
              <input type="email" id="auth-email" class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email Address" autocomplete="email"/>
              <input type="password" id="auth-password" class="w-full px-4 py-3 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password" autocomplete="current-password"/>
              <p id="auth-error" class="text-red-500 text-sm text-center h-5"></p>
            </div>
            <button id="auth-submit-btn" class="mt-6 w-full px-4 py-3 bg-indigo-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
              Log In
            </button>
            <p class="text-sm text-center text-gray-500 mt-4">
              <span id="auth-switch-text">Don't have an account?</span>
              <a href="#" id="auth-switch-link" class="font-medium text-indigo-600 hover:underline">Sign Up</a>
            </p>
          </div>
        </div>
        <button id="auth-close-btn" class="absolute top-0 right-0 m-4 text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
      </div>
    </div>
    <!-- END: AUTHENTICATION MODAL -->

    <script type="module">
        import { updateAuthUI, protectPage } from './auth.js';
        updateAuthUI();
        protectPage();
    </script>

    <script type="module">
        import { login, signup } from './auth.js';
        
        const modal = document.getElementById('auth-modal');
        const closeBtn = document.getElementById('auth-close-btn');
        if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; document.getElementById('auth-error').textContent = ''; });
        window.addEventListener('click', (event) => { if (event.target === modal) { modal.style.display = 'none'; document.getElementById('auth-error').textContent = ''; } });

        let isLoginMode = true;
        const title = document.getElementById('auth-modal-title');
        const submitBtn = document.getElementById('auth-submit-btn');
        const switchText = document.getElementById('auth-switch-text');
        const switchLink = document.getElementById('auth-switch-link');
        const errorEl = document.getElementById('auth-error');
        const passwordInput = document.getElementById('auth-password');

        switchLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            title.textContent = isLoginMode ? 'Log In' : 'Sign Up';
            submitBtn.textContent = isLoginMode ? 'Log In' : 'Sign Up';
            switchText.textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
            switchLink.textContent = isLoginMode ? 'Sign Up' : 'Log In';
            passwordInput.setAttribute('autocomplete', isLoginMode ? 'current-password' : 'new-password');
            errorEl.textContent = '';
        });

        submitBtn.addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            errorEl.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                if (isLoginMode) { await login(email, password); } 
                else { await signup(email, password); }
                modal.style.display = 'none';
                window.location.reload();
            } catch (err) {
                errorEl.textContent = err.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isLoginMode ? 'Log In' : 'Sign Up';
            }
        });
    </script>
</body>
</html>
